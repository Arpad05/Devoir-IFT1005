var listJSON=null;
var ID=null;
//fonction permettant les requêtes xml
function getXHR(){
    var xhrObject = null;
    if(window.XMLHttpRequest){
        xhrObject = new XMLHttpRequest();
    }else{
        alert("Votre navigateur actuelle ne supporte pas les XMLHttpRequest.\n"+
        "Veuillez essayer avec un autre navigateur");
        xhrObject = false;
    }
    return xhrObject;
}
//fonction permettant de retrouver les données dans le fichier json et de l'afficher
function chargementFichierJson(){
    const xhrObject = getXHR();
    xhrObject.onload=function(){
        fichierJson(this.responseText);
    };
    xhrObject.open("GET","./data/products.json");
    xhrObject.send();
}
// sous fonction de la méthode chargementFichierJson
function fichierJson(json){
    var ObjJSON=JSON.parse(json);
    ObjJSON.sort(function(a,b){
        return parseFloat(a.price) - parseFloat(b.price);
    });
    listJSON = ObjJSON;
    let listDeProduits=document.getElementById("products-list");
    affichage(listDeProduits,listJSON);
}
// permet l'affichage des produits dans products.html
function affichage(listDeProduits, ObjJSON){
    for (var i = 0; i < ObjJSON.length; i++){
        if (i==0){
            listDeProduits.innerHTML="<div id=\""+ ObjJSON[i].id +"\" class=\"product\">\n<a href=\"./product.html\?id="+ encodeURI(ObjJSON[i].id)+"\" title=\"En savoir plus...\">\n"
            +"<h2>"+ObjJSON[i].name+"</h2>\n"
            +"<img src=\"./assets/img/"+ ObjJSON[i].image +"\">\n"
            +"<p class=\"price\"><small>Prix</small>"+ ObjJSON[i].price +"&thinsp;$</p>\n"
            +"</a>\n"
            +"</div>\n";
        }else{
            listDeProduits.innerHTML+="<div id=\""+ ObjJSON[i].id +"\" class=\"product\">\n<a href=\"./product.html\?id="+ encodeURI(ObjJSON[i].id)+"\"title=\"En savoir plus...\">\n"
            +"<h2>"+ObjJSON[i].name+"</h2>\n"
            +"<img src=\"./assets/img/"+ ObjJSON[i].image +"\">\n"
            +"<p class=\"price\"><small>Prix</small>"+ ObjJSON[i].price +"&thinsp;$</p>\n"
            +"</a>\n"
            +"</div>\n";
        }
    }
}
//permet l'affichage d'un produit en détail
function chargementProduit(){
    const xhrObject = getXHR();
    var address=document.URL.indexOf('?');
    var params = new Array();
    xhrObject.onload=function(){
        params=parameters(address,params)
        chargementPageProduit(this.responseText,params.id)
        submitForm();
    };
    xhrObject.open("GET","./data/products.json");
    xhrObject.send();
}
//permet de retrouver des paramètres passés par URL
function parameters(address, params){
    var pairs = document.URL.substring(address+1, document.URL.length).split('&');
    for (var i=0; i<pairs.length; i++) {
        nameVal = pairs[i].split('=');
        params[nameVal[0]] = nameVal[1];
        console.log(params[nameVal[0]]);
    }
    return params
}
//vérification que l'ID est un nombre
function seulementNombre(str) {
    return /^\d+$/.test(str);
}

// sous-fonction de  chargementProduit
function chargementPageProduit(json, id){
    var ObjJSON=JSON.parse(json);
    listJSON= ObjJSON;
    let productPage=document.getElementsByTagName("article");
    if(id>ObjJSON.length || id<1 || !(seulementNombre(id))){
        productPage[0].innerHTML="<h1 style=\"color: red\">Page non trouvée</h1>"
    }else{
        ID=id;
    for(var i=0; i<ObjJSON.length; i++){
        if(ObjJSON[i].id==id){
            productPage[0].innerHTML="<h1>"+ObjJSON[i].name+"</h1>"+
            "<div class=\"row\">\n"+
            "\t<div class=\"col\">\n"+
            "\t\t<img id=\"product-image\" alt=\""+ ObjJSON[i].name +"\" src=\"./assets/img/"+ ObjJSON[i].image +"\">\n"+
            "\t</div>\n"+
            "\t<div class=\"col\">\n"+
            "\t\t<section>\n"+
            "\t\t\t<h2>Description</h2>\n"+
            "\t\t\t<p>"+ ObjJSON[i].description +"</p>\n"+
            "\t\t</section>\n"+
            "\t\t<section>\n"+
            "\t\t\t<h2>Caractéristiques</h2>\n"+
            "\t\t\t<ul>\n"+//;
            "\t\t\t\t<li>"+ObjJSON[i].features[0]+"</li>\n"+
            "\t\t\t\t<li>"+ObjJSON[i].features[1]+"</li>\n"+
            "\t\t\t\t<li>"+ObjJSON[i].features[2]+"</li>\n"+
            "\t\t\t\t<li>"+ObjJSON[i].features[3]+"</li>\n"+
            "\t\t\t\t<li>"+ObjJSON[i].features[4]+"</li>\n"+
            "\t\t\t</ul>\n"+
            "\t\t</section>\n"+
            "\t\t<hr>\n"+
            "\t\t<form class=\"pull-right\">\n"+
            "\t\t\t<label for=\"product-quantity\">Quantité:</label>"+
            "\t\t\t<input class=\"form-control\" id=\"product-quantity\" type=\"number\" value=\"1\" min=\"1\">"+
            "\t\t\t<button class=\"btn\" title=\"Ajouter au panier\" type=\"submit\">"+
            "\t\t\t\t<i class=\"fa fa-cart-plus\"></i>&nbsp; Ajouter"+
            "\t\t\t</button>"+
            "\t\t</form>"+
            "\t\t<p>Prix: <strong>"+ ObjJSON[i].price +"&thinsp;$</strong></p>"+
            "\t</div>"+
            "</div>"
        }
    }
}
}
//permet de filtrer les produits par classement
function filtre2(){
    const xhrObject=getXHR();
    xhrObject.onload=function(){
        console.log(listJSON)
        FiltrageParClassement(this.responseText);
    };
    xhrObject.open("GET","./data/products.json");
    xhrObject.send();
}
// permet de filtrer les produits par catégories
function filtre1(){
    const xhrObject=getXHR();
    xhrObject.onload=function(){
        filtrageParCategorie(this.responseText);
    };
    xhrObject.open("GET","./data/products.json");
    xhrObject.send();
}

//différent cas de filtrage par catégorie
function filtrageParCategorie(json){
    var ObjJSON = JSON.parse(json);
    var tmpArray=new Array();
    var divListBouttons = document.getElementById("product-categories").querySelectorAll("button");
    divListBouttons.forEach(function callback(button, index) {
        button.addEventListener('click',function(){
            divListBouttons.forEach(btn => btn.classList.remove('selected'));
            this.classList.add('selected');
            switch (index) {
                case 0:
                    for (var i = 0; i<ObjJSON.length; i++){
                        if(ObjJSON[i].category=="cameras"){
                            tmpArray.push(ObjJSON[i]);
                        }
                    }
                    listJSON=tmpArray;
                    break;
                case 1:
                    for (var i = 0; i<ObjJSON.length; i++){
                        if(ObjJSON[i].category=="consoles"){
                            tmpArray.push(ObjJSON[i]);
                        }
                    }
                    listJSON=tmpArray;
                    break;
                case 2:
                    for (var i = 0; i<ObjJSON.length; i++){
                        if(ObjJSON[i].category=="screens"){
                            tmpArray.push(ObjJSON[i]);
                        }
                    }
                    listJSON=tmpArray;
                    break;
                case 3:
                    for (var i = 0; i<ObjJSON.length; i++){
                        if(ObjJSON[i].category=="computers"){
                            tmpArray.push(ObjJSON[i]);
                        }
                    }
                    listJSON=tmpArray;
                    break;
                case 4:
                    listJSON=ObjJSON;
                    break;
                default:
                    break;
            }
            var buttonArray=document.getElementById("product-criteria").querySelectorAll("button");
            buttonArray.forEach(function callback(button, index) {
                if(button.className=='selected'){
                    console.log(true);
                    trieur(index);
                }
            });
            document.getElementById("products-count").innerHTML=listJSON.length + " produits";
            let listDeProduits=document.getElementById("products-list");
            affichage(listDeProduits,listJSON);
        });
    });
}
//filtrage par classement
function FiltrageParClassement(json){
    var divListBouttons = document.getElementById("product-criteria");
    var buttonArray=divListBouttons.querySelectorAll("button");
    buttonArray.forEach(function callback(button, index) {
        button.addEventListener('click',function(){
            buttonArray.forEach(btn => btn.classList.remove('selected'));
            this.classList.add('selected');
            trieur(index);
            document.getElementById("products-count").innerHTML=listJSON.length + " produits";
            let listDeProduits=document.getElementById("products-list");
            affichage(listDeProduits,listJSON);
        });
    });
}
//cas de filtrage par classement
function trieur(index){
    switch (index) {
        case 0:
            listJSON.sort(function(a,b){
                return parseFloat(a.price) - parseFloat(b.price);
            });
            break;
        case 1:
            listJSON.sort(function(a,b){
                return parseFloat(b.price) - parseFloat(a.price);
            });
            break;
        case 2:
            listJSON.sort(function(a,b){
                return a.name.localeCompare(b.name);
            });
            break;
        case 3:
            listJSON.sort(function(a,b){
                return b.name.localeCompare(a.name);
            });
            break;
        default:
            break;
    }
}
//permet d'ajouter un élément dans le local storage

function submitForm(){
    var submitButton=document.querySelector('.btn');
    
    submitButton.addEventListener('click', function(event){
        
        var qty=(document.querySelector("input[type=number]").value);
        event.preventDefault();
        var name = listJSON[ID-1].name;
        var transfert;
        var oldQuantity = 0;
        if(window.localStorage.getItem(name)===null){
        transfert={id:ID, name:listJSON[ID-1].name, quantity:qty, price:listJSON[ID-1].price}
        }else{
            oldQuantity = JSON.parse(window.localStorage.getItem(name)).quantity;
            qty=parseInt(oldQuantity)+parseInt(qty);
            transfert={id:ID, name:listJSON[ID-1].name, quantity:qty, price:listJSON[ID-1].price}
        }
        window.localStorage.setItem(name, JSON.stringify(transfert));
        window.location.href='/product.html\?id='+ encodeURI(ID);

        //update du nombre d'items dans le panier
        window.localStorage.setItem('itemsInCart', 'true');
        var nbItems = parseInt(window.localStorage.getItem('nbItems'));
        if (nbItems){nbItems = nbItems + parseInt(qty) - parseInt(oldQuantity);} else{nbItems = qty;}
        window.localStorage.setItem('nbItems', nbItems.toString());
        
    });
}


//Fonction qui retire un item du panier lorsqu'on clique sur X
function removeItem(){

    if (confirm("Voulez-vous supprimer le produit du panier ?")){
    

        //retirer l'item du panier
        $('table').on('click', '.remove-item-button', function(event){
            var itemName = $(this).closest('td').next().children().html();
            $(this).closest('tr').remove();

            //Mettre à jour le localStorage
            for (var i =0; i< window.localStorage.length; i++){
                var key = window.localStorage.key(i);
                
                if (key == itemName) {
                    var jsonItem = JSON.parse(window.localStorage.getItem(key));
                    
                    //update le nb d'items
                    var nbItems = parseInt(window.localStorage.getItem('nbItems'));
                    nbItems -= jsonItem.quantity;
                    window.localStorage.setItem('nbItems', nbItems.toString());
                    if (nbItems == 0){ //verifier s'il n'y a plus d'items
                        window.localStorage.setItem('itemsInCart', 'false');
                        $('.count').hide();
                        $(".shopping-cart-article" ).append( "<p>Aucun produit dans le panier.</p>" );
                        $('#shopping-cart-items').hide();
                    }
                    $('.count')[0].innerHTML = window.localStorage.getItem('nbItems');
                    $('.count').show();

                    //update le prix total
                    var totalPrice = parseFloat(window.localStorage.getItem('totalPrice'));
                    totalPrice -= parseInt(jsonItem.quantity) * parseFloat(jsonItem.price);
                    window.localStorage.setItem('totalPrice', totalPrice.toFixed(2));
                    $('.shopping-cart-total').html("Total: <strong>" + totalPrice.toFixed(2) + "&thinsp;$</strong>");

                    window.localStorage.removeItem(key);
                    break;
                }
            }
        });

    }

}

function removeQuantity() {

    //$('.remove-quantity-button').unbind('click');
    $('table').unbind().on('click', '.remove-quantity-button', function(event){
        
        var itemName = $(this).closest('td').prev().prev().children().html(); //nom de l'item dont on veut retirer une quantite

        //trouver l'item dans le localStorage
        for (var i =0; i< window.localStorage.length; i++){
            var key = window.localStorage.key(i);
            
            if (key == itemName) {

                var jsonItem = JSON.parse(window.localStorage.getItem(key));
                //update la quantite
                var quantity = parseInt(jsonItem.quantity);
                quantity--;
                jsonItem.quantity = quantity.toString();
                window.localStorage.setItem(key, JSON.stringify(jsonItem));
                $(this).closest('td').children().children().eq(1).html(jsonItem.quantity);
                if (quantity == 1){
                    $(this).closest('td').find('.remove-quantity-button').prop('disabled', true);
                }

                //update le prix
                var totalPrice = parseFloat(window.localStorage.getItem('totalPrice'));
                totalPrice -= parseFloat(jsonItem.price);
                window.localStorage.setItem('totalPrice', totalPrice.toFixed(2));
                $('.shopping-cart-total').html("Total: <strong>" + totalPrice.toFixed(2) + "&thinsp;$</strong>");
                var itemTotalPrice = parseFloat(jsonItem.price) * parseInt(jsonItem.quantity);
                $(this).closest('td').next().html(itemTotalPrice.toFixed(2) + ' $');

                //update le nbItems
                var nbItems = parseInt(window.localStorage.getItem('nbItems'));
                nbItems--;
                window.localStorage.setItem('nbItems', nbItems.toString());
                if (nbItems == 0){ //verifier s'il n'y a plus d'items
                    window.localStorage.setItem('itemsInCart', 'false');
                    window.localStorage.removeItem(key);
                    $('.count').hide();
                    $(".shopping-cart-article" ).append( "<p>Aucun produit dans le panier.</p>" );
                    $('#shopping-cart-items').hide();
                }
                
                $('.count')[0].innerHTML = window.localStorage.getItem('nbItems');
                $('.count').show();

                break;
            }
        }

    });
}


function addQuantity() {

    $('table').unbind().on('click', '.add-quantity-button', function(event){
        
        var itemName = $(this).closest('td').prev().prev().children().html(); //nom de l'item auquel on veut ajouter une quantite

        //trouver l'item dans le localStorage
        for (var i =0; i< window.localStorage.length; i++){
            var key = window.localStorage.key(i);
            
            if (key == itemName) {

                var jsonItem = JSON.parse(window.localStorage.getItem(key));
                //update la quantite
                var quantity = parseInt(jsonItem.quantity);
                quantity++;
                jsonItem.quantity = quantity.toString();
                window.localStorage.setItem(key, JSON.stringify(jsonItem));
                $(this).closest('td').children().children().eq(1).html(jsonItem.quantity);
                $(this).closest('td').find('.remove-quantity-button').prop('disabled', false);

                //update le prix
                var totalPrice = parseFloat(window.localStorage.getItem('totalPrice'));
                totalPrice += parseFloat(jsonItem.price);
                window.localStorage.setItem('totalPrice', totalPrice.toFixed(2));
                $('.shopping-cart-total').html("Total: <strong>" + totalPrice.toFixed(2) + "&thinsp;$</strong>");
                var itemTotalPrice = parseFloat(jsonItem.price) * parseInt(jsonItem.quantity)
                $(this).closest('td').next().html(itemTotalPrice.toFixed(2) + ' $');

                //update le nbItems
                var nbItems = parseInt(window.localStorage.getItem('nbItems'));
                nbItems++;
                window.localStorage.setItem('nbItems', nbItems.toString());
                if (nbItems == 0){ //verifier s'il n'y a plus d'items
                    window.localStorage.setItem('itemsInCart', 'false');
                    window.localStorage.removeItem(key);
                    $('.count').hide();
                    $(".shopping-cart-article" ).append( "<p>Aucun produit dans le panier.</p>" );
                    $('#shopping-cart-items').hide();
                }
                
                $('.count')[0].innerHTML = window.localStorage.getItem('nbItems');
                $('.count').show();

                break;
            }
        }

    });
}

//Fonction qui affiche les bons items dans le panier
function showShoppingCart(){

    var items= [];
    var totalItemsPrice = 0; //prix total de tous les items dans le panier

    //get items from the local storage
    for (var i = 0; i < window.localStorage.length; i++) {
        var key = window.localStorage.key(i);
        if (key != 'nbItems' && key != 'itemsInCart' && key != 'totalPrice' && !(userData(key))){
            var value = localStorage.getItem(key);
            items.push(value);
        }
    }

    items.sort();
    
    items.forEach(fillShoppingCart);
    
    //fonction effectuée sur chacun des items dans le localStorage
    function fillShoppingCart(value, index, array){
        var jsonItem = JSON.parse(value);
        var totalPrice = parseInt(jsonItem.quantity) * parseFloat(jsonItem.price);
        
        var disabled;
        if (jsonItem.quantity == '1'){disabled = ' disabled = \"true\" ';} else{disabled = '';}
        
        let row = '<tr> <td><button class = \"remove-item-button\" title=\"Supprimer\" onclick=\"removeItem(event);\" ><i class=\"fa fa-times\"></i></button></td>' 
        + '<td> <a href=\".product.html">' + jsonItem.name + '</a></td>'
        + '<td>' + jsonItem.price + '&thinsp;$</td>' +
        '<td><div class=\"row\"><div class=\"col\"><button class = \"remove-quantity-button\" title=\"Retirer\" onclick=\"removeQuantity(event);\"'+ disabled +'><i class=\"fa fa-minus\"></i></button></div><div class=\"col quantity\">' 
        + jsonItem.quantity
        + '</div><div class=\"col\"><button class=\"add-quantity-button\" title=\"Ajouter\" onclick=\"addQuantity(event);\"><i class=\"fa fa-plus\"></i></button></div></div></td>'
        + '<td>' + totalPrice.toFixed(2) + '&thinsp;$</td> </tr>'

        $('tbody').append(row);
        totalItemsPrice += totalPrice;

    }

    window.localStorage.setItem('totalPrice', totalItemsPrice.toFixed(2));

    // $('.shopping-cart-total').innerHTML = "Total: <strong>" + totalItemsPrice + "&thinsp;$</strong>";
}


//fonction qui vide le panier d'achats
function emptyCart(){

    if (confirm("Voulez vous supprimer tous les produits du panier ?")){
        //Supprimer les items du localStorage
        var removeList = []; //Liste des keys a supprimer du localStorage
        for (var i = 0; i < window.localStorage.length; i++) {
            var key = window.localStorage.key(i);
            if (key != 'nbItems' && key != 'itemsInCart' && key != 'totalPrice'){
                removeList.push(key);
            }
        }

        for (var i=0; i < removeList.length; i++) {
            window.localStorage.removeItem(removeList[i]);
        }

        //remettre les variables a 0
        window.localStorage.setItem('itemsInCart', 'false');
        window.localStorage.setItem('nbItems', '0');
        window.localStorage.setItem('totalPrice', '0');

        //Changer l'affichage
        $('.count').hide();
        $(".shopping-cart-article" ).append( "<p>Aucun produit dans le panier.</p>" );
        $('#shopping-cart-items').hide();
    }
}


$(document).ready(function (){
//solution temporaire
    var url=window.location.href;
    if(url.toString().includes("confirmation.html")){
        updateCommandeText();
    }
    var itemsInCart = window.localStorage.getItem('itemsInCart') === 'true';
    // Si l'élément n'était pas visible avant le rechargement de la page, on le cache
    if (!itemsInCart) {

        $('.count').hide();
        $(".shopping-cart-article" ).append( "<p>Aucun produit dans le panier.</p>" );
        $('#shopping-cart-items').hide();

    }else{
        $('.count')[0].innerHTML = window.localStorage.getItem('nbItems');
        $('.count').show();
        showShoppingCart();
        var totalPrice = window.localStorage.getItem('totalPrice');
        $('.shopping-cart-total').html("Total: <strong>" + totalPrice + "&thinsp;$</strong>");

    }
    // Initialisez la validation de formulaire
    // Vérifiez si le formulaire existe sur la page
    if ($( '#form-order' ).length) {
        var btn = document.getElementById("soumission");
        console.log("rendu au validation");
	    $( '#form-order' ).validate({
		  rules: {
		    first_name: {
          required: true,
          minlength: 2
        },
        last_name: {
          required: true,
          minlength: 2
        },
        email: {
          required: true,
          email: true
        },
        phone: {
          required: true,
          phoneUS: true
        },
        credit_card: {
          required: true,
          creditcard: true
        },
        credit_card_expiry: {
          required: true
        }
      },
      messages: {
        // Définissez les messages d'erreur ici
        first_name: {
          required: "Veuillez remplir ce champs",
          minlength: "Veuillez forunir au moins 2 caractères"
        },
        last_name: {
          required: "Veuillez remplir ce champs",
          minlength: "Veuillez forunir au moins 2 caractères"
        },
        email: {
          required: "Veuillez remplir ce champs",
          email: "Veuillez entrer une adresse email valide"
        },
        phone: {
          required: "Veuillez remplir ce champs",
          phoneUS: "Veuillez entrer un numéro de téléphone valide"
        },
        credit_card: {
          required: "Veuillez remplir ce champs",
          creditcard: "Veuillez entrer un numéro de carte valide"
        },
        credit_card_expiry: {
          required: "Veuillez remplir ce champs"
        }
      }
	  });
      btn.addEventListener("click", function(){
        updateCommande();
        newCommand();
      });
   }
});

// fonction permettant de vérifier s'il y a déjà eu un command pour ce nom
function updateCommande(){
    var prenom = document.getElementById("first_name").value;
    var nom = document.getElementById("last_name").value;
    var nomComplet=prenom+"-"+nom.toUpperCase();
    if(localStorage.getItem(nomComplet)===null){
        window.localStorage.setItem(nomComplet,JSON.stringify({firstName:prenom,lastName:nom,orderNumber:1}));
    }else{
        var oldNumber = JSON.parse(window.localStorage.getItem(nomComplet)).orderNumber;
        var newNumber = parseInt(oldNumber) + 1;
        window.localStorage.setItem(nomComplet, JSON.stringify({firstName:prenom,lastName:nom,orderNumber:newNumber}));
    }
}

//Page confirmation
function updateCommandeText(){
    var address=document.URL.indexOf('?');
    var params = new Array();
    params=parameters(address,params);
    var key=params.first_name+"-"+params.last_name.toUpperCase();
    var prenom_element = document.getElementById("prenom");
    var nom_element = document.getElementById("nom");
    var numero_element = document.getElementById("numero");
    prenom_element.innerHTML = JSON.parse(window.localStorage.getItem(key)).firstName;
    nom_element.innerHTML = JSON.parse(window.localStorage.getItem(key)).lastName;
    numero_element.innerHTML = JSON.parse(window.localStorage.getItem(key)).orderNumber;
}

//fonction qui vide le panier quand une commande est créée
function newCommand(){

    if ($('#form-order').valid()) {
        //Supprimer les items du localStorage
        var removeList = []; //Liste des keys a supprimer du localStorage
        for (var i = 0; i < window.localStorage.length; i++) {
            var key = window.localStorage.key(i);
            if (key != 'nbItems' && key != 'itemsInCart' && key != 'totalPrice' && !(userData(key))){
                console.log("effacement")
                removeList.push(key);
                console.log(key);
            }
        }
        for (var i=0; i < removeList.length; i++) {
            window.localStorage.removeItem(removeList[i]);
        }
        //remettre les variables a 0
        window.localStorage.setItem('itemsInCart', 'false');
        window.localStorage.setItem('nbItems', '0');
        window.localStorage.setItem('totalPrice', '0');
        //Changer l'affichage
        $('#prenom').append("a");
        $('#nom').append("a");
    }
}
function userData(key){
    return /[a-zA-Z]{2,}-[A-Z]{2,}/.test(key);
}