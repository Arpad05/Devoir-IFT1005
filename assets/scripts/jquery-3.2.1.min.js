//var ID=null;
var listJSON=null;
var ID=null;
//var productForm=null;
function getXHR(){
    var xhrObject = null;
    if(window.XMLHttpRequest){
        xhrObject = new XMLHttpRequest();
    }else{
        alert("Votre navigateur actuelle ne supporte pas les XMLHttpRequest.\n"+
        "Veuillez essayer avec un autre navigateur");
        xhrObject = false;
    }
    return xhrObject;
}
function chargementFichierJson(){
    const xhrObject = getXHR();
    xhrObject.onload=function(){
        fichierJson(this.responseText);
    };
    xhrObject.open("GET","./data/products.json");
    xhrObject.send();
}

function fichierJson(json){
    var ObjJSON=JSON.parse(json);
    ObjJSON.sort(function(a,b){
        return parseFloat(a.price) - parseFloat(b.price);
    });
    listJSON = ObjJSON;
    let listDeProduits=document.getElementById("products-list");
    affichage(listDeProduits,listJSON);
}

function affichage(listDeProduits, ObjJSON){
    for (var i = 0; i < ObjJSON.length; i++){
        if (i==0){
            listDeProduits.innerHTML="<div id=\""+ ObjJSON[i].id +"\" class=\"product\">\n<a href=\"./product.html\?id="+ encodeURI(ObjJSON[i].id)+"\" title=\"En savoir plus...\">\n"
            +"<h2>"+ObjJSON[i].name+"</h2>\n"
            +"<img src=\"./assets/img/"+ ObjJSON[i].image +"\">\n"
            +"<p class=\"price\"><small>Prix</small>"+ ObjJSON[i].price +"&thinsp;$</p>\n"
            +"</a>\n"
            +"</div>\n";
        }else{
            listDeProduits.innerHTML+="<div id=\""+ ObjJSON[i].id +"\" class=\"product\">\n<a href=\"./product.html\?id="+ encodeURI(ObjJSON[i].id)+"\"title=\"En savoir plus...\">\n"
            +"<h2>"+ObjJSON[i].name+"</h2>\n"
            +"<img src=\"./assets/img/"+ ObjJSON[i].image +"\">\n"
            +"<p class=\"price\"><small>Prix</small>"+ ObjJSON[i].price +"&thinsp;$</p>\n"
            +"</a>\n"
            +"</div>\n";
        }
    }
}

function chargementProduit(){
    const xhrObject = getXHR();
    var address=document.URL.indexOf('?');
    console.log(address);
    var params = new Array();
    xhrObject.onload=function(){
        params=parameters(address,params)
        chargementPageProduit(this.responseText,params.id)
        submitForm();
    };
    xhrObject.open("GET","./data/products.json");
    xhrObject.send();
}

function parameters(address, params){
    console.log("test");
    var pairs = document.URL.substring(address+1, document.URL.length).split('&');
    for (var i=0; i<pairs.length; i++) {
        nameVal = pairs[i].split('=');
        params[nameVal[0]] = nameVal[1];
        console.log(params[nameVal[0]]);
    }
    return params
}

function seulementNombre(str) {
    return /^\d+$/.test(str);
  }
function chargementPageProduit(json, id){
    var ObjJSON=JSON.parse(json);
    listJSON= ObjJSON;
    let productPage=document.getElementsByTagName("article");
    if(id>ObjJSON.length || id<1 || !(seulementNombre(id))){
        productPage[0].innerHTML="<h1 style=\"color: red\">Page non trouvée</h1>"
    }else{
        ID=id;
    for(var i=0; i<ObjJSON.length; i++){
        if(ObjJSON[i].id==id){
            productPage[0].innerHTML="<h1>"+ObjJSON[i].name+"</h1>"+
            "<div class=\"row\">\n"+
            "\t<div class=\"col\">\n"+
            "\t\t<img id=\"product-image\" alt=\""+ ObjJSON[i].name +"\" src=\"./assets/img/"+ ObjJSON[i].image +"\">\n"+
            "\t</div>\n"+
            "\t<div class=\"col\">\n"+
            "\t\t<section>\n"+
            "\t\t\t<h2>Description</h2>\n"+
            "\t\t\t<p>"+ ObjJSON[i].description +"</p>\n"+
            "\t\t</section>\n"+
            "\t\t<section>\n"+
            "\t\t\t<h2>Caractéristiques</h2>\n"+
            "\t\t\t<ul>\n"+//;
            "\t\t\t\t<li>"+ObjJSON[i].features[0]+"</li>\n"+
            "\t\t\t\t<li>"+ObjJSON[i].features[1]+"</li>\n"+
            "\t\t\t\t<li>"+ObjJSON[i].features[2]+"</li>\n"+
            "\t\t\t\t<li>"+ObjJSON[i].features[3]+"</li>\n"+
            "\t\t\t\t<li>"+ObjJSON[i].features[4]+"</li>\n"+
            "\t\t\t</ul>\n"+
            "\t\t</section>\n"+
            "\t\t<hr>\n"+
            "\t\t<form class=\"pull-right\">\n"+
            "\t\t\t<label for=\"product-quantity\">Quantité:</label>"+
            "\t\t\t<input class=\"form-control\" id=\"product-quantity\" type=\"number\" value=\"1\" min=\"1\">"+
            "\t\t\t<button class=\"btn\" title=\"Ajouter au panier\" type=\"submit\">"+
            "\t\t\t\t<i class=\"fa fa-cart-plus\"></i>&nbsp; Ajouter"+
            "\t\t\t</button>"+
            "\t\t</form>"+
            "\t\t<p>Prix: <strong>"+ ObjJSON[i].price +"&thinsp;$</strong></p>"+
            "\t</div>"+
            "</div>"
        }
    }
}
}

function filtre2(){
    const xhrObject=getXHR();
    xhrObject.onload=function(){
        console.log(listJSON)
        FiltrageParClassement(this.responseText);
    };
    xhrObject.open("GET","./data/products.json");
    xhrObject.send();
}

function filtre1(){
    const xhrObject=getXHR();
    xhrObject.onload=function(){
        filtrageParCategorie(this.responseText);
    };
    xhrObject.open("GET","./data/products.json");
    xhrObject.send();
}
function filtrageParCategorie(json){
    var ObjJSON = JSON.parse(json);
    var tmpArray=new Array();
    var divListBouttons = document.getElementById("product-categories").querySelectorAll("button");
    divListBouttons.forEach(function callback(button, index) {
        button.addEventListener('click',function(){
            divListBouttons.forEach(btn => btn.classList.remove('selected'));
            this.classList.add('selected');
            switch (index) {
                case 0:
                    for (var i = 0; i<ObjJSON.length; i++){
                        if(ObjJSON[i].category=="cameras"){
                            tmpArray.push(ObjJSON[i]);
                        }
                    }
                    listJSON=tmpArray;
                    break;
                case 1:
                    for (var i = 0; i<ObjJSON.length; i++){
                        if(ObjJSON[i].category=="consoles"){
                            tmpArray.push(ObjJSON[i]);
                        }
                    }
                    listJSON=tmpArray;
                    break;
                case 2:
                    for (var i = 0; i<ObjJSON.length; i++){
                        if(ObjJSON[i].category=="screens"){
                            tmpArray.push(ObjJSON[i]);
                        }
                    }
                    listJSON=tmpArray;
                    break;
                case 3:
                    for (var i = 0; i<ObjJSON.length; i++){
                        if(ObjJSON[i].category=="computers"){
                            tmpArray.push(ObjJSON[i]);
                        }
                    }
                    listJSON=tmpArray;
                    break;
                case 4:
                    listJSON=ObjJSON;
                    break;
                default:
                    break;
            }
            var buttonArray=document.getElementById("product-criteria").querySelectorAll("button");
            buttonArray.forEach(function callback(button, index) {
                if(button.className=='selected'){
                    console.log(true);
                    trieur(index);
                }
            });
            document.getElementById("products-count").innerHTML=listJSON.length + " produits";
            let listDeProduits=document.getElementById("products-list");
            affichage(listDeProduits,listJSON);
        });
    });
}

function FiltrageParClassement(json){
    var divListBouttons = document.getElementById("product-criteria");
    var buttonArray=divListBouttons.querySelectorAll("button");
    buttonArray.forEach(function callback(button, index) {
        button.addEventListener('click',function(){
            buttonArray.forEach(btn => btn.classList.remove('selected'));
            this.classList.add('selected');
            trieur(index);
            document.getElementById("products-count").innerHTML=listJSON.length + " produits";
            let listDeProduits=document.getElementById("products-list");
            affichage(listDeProduits,listJSON);
        });
    });
}
function trieur(index){
    switch (index) {
        case 0:
            listJSON.sort(function(a,b){
                return parseFloat(a.price) - parseFloat(b.price);
            });
            break;
        case 1:
            listJSON.sort(function(a,b){
                return parseFloat(b.price) - parseFloat(a.price);
            });
            break;
        case 2:
            listJSON.sort(function(a,b){
                return a.name.localeCompare(b.name);
            });
            break;
        case 3:
            listJSON.sort(function(a,b){
                return b.name.localeCompare(a.name);
            });
            break;
        default:
            break;
    }
}
function ajouterElement(){
    var montant=document.getElementById("product-quantity").value;
    var transfert={id:ID, name:listJSON[ID-1].name, quantity:montant, price:listJSON[ID-1].price}
    var myJsonObj=JSON.stringify(transfert);
    console.log("test");
    window.localStorage.setItem(listJSON[ID-1].name, myJsonObj);
    //window.location.href='/product.html\?id='+ encodeURI(ID)
    chargementPageProduit(listJSON, ID)
}
function submitForm(){

    var myForm=document.getElementById("add-to-cart-form");
    var submitButton=document.querySelector('.btn');
    
    submitButton.addEventListener('click', function(event){
        
        var qty=(document.querySelector("input[type=number]").value);
        event.preventDefault();
        var name = listJSON[ID-1].name;
        var transfert;
        var oldQuantity = 0;
        if(window.localStorage.getItem(name)===null){
        transfert={id:ID, name:listJSON[ID-1].name, quantity:qty, price:listJSON[ID-1].price}
        }else{
            oldQuantity = JSON.parse(window.localStorage.getItem(name)).quantity;
            qty=parseInt(oldQuantity)+parseInt(qty);
            transfert={id:ID, name:listJSON[ID-1].name, quantity:qty, price:listJSON[ID-1].price}
        }
        window.localStorage.setItem(name, JSON.stringify(transfert));
        window.location.href='/product.html\?id='+ encodeURI(ID);

        //update du nombre d'items dans le panier
        window.localStorage.setItem('itemsInCart', 'true');
        var nbItems = parseInt(window.localStorage.getItem('nbItems'));
        if (nbItems){nbItems = nbItems + parseInt(qty) - parseInt(oldQuantity);} else{nbItems = qty;}
        window.localStorage.setItem('nbItems', nbItems.toString());
        
    });
}

function showShoppingCart(){

    items= [];
    //get items in the local storage
    // iterate localStorage
    for (var i = 0; i < window.localStorage.length; i++) {
        var key = localStorage.key(i);
        if (key != 'nbItems' && key != 'itemsInCart'){
            var value = localStorage.getItem(key);
            items.push(value);
        }
    }
    console.log(items.toString());
    
    items.forEach(fillShoppingCart);
    
    function fillShoppingCart(value, index, array){
        var jsonItem = JSON.parse(value);
        var totalPrice = parseInt(jsonItem.quantity) * parseFloat(jsonItem.price);
        
        let row = '<tr> <td><button title="Supprimer"><i class="fa fa-times"></i></button></td>' 
        + '<td> <a href=\".product.html">' + jsonItem.name + '</a></td>'
        + '<td>' + jsonItem.price + '&thinsp;$</td>' +
        '<td><div class=\"row\"><div class=\"col\"><button title=\"Retirer\" disabled=\"\"><i class=\"fa fa-minus\"></i></button></div><div class=\"col\">' 
        + jsonItem.quantity
        + '</div><div class=\"col\"><button title=\"Ajouter\"><i class=\"fa fa-plus\"></i></button></div></div></td>'
        + '<td>' + totalPrice.toString() + '&thinsp;$</td> </tr>'

        $('tbody').append(row);

    }
    //let row = '<tr> <td>' + $("#insert-name").val() + '</td> <td>' + $("#insert-surname").val() + '</td> <td>' + "edit" + '</td> </tr>'
    //$('tbody').append(row);
}


$(document).ready(function (){
    var itemsInCart = window.localStorage.getItem('itemsInCart') === 'true';
    // Si l'élément n'était pas visible avant le rechargement de la page, on le cache
    if (!itemsInCart) {

        $('.count').hide();
        $(".shopping-cart-article" ).append( "<p>Aucun produit dans le panier.</p>" );
        $('#shopping-cart-items').hide();

    }else{
        $('.count')[0].innerHTML = window.localStorage.getItem('nbItems');
        $('.count').show();
        showShoppingCart();

    }
});


/* <tr>
              <td><button title="Supprimer"><i class="fa fa-times"></i></button></td>
              <td><a href="./product.html">Console Wii</a></td>
              <td>199,99&thinsp;$</td>
              <td>
                <div class="row">
                  <div class="col">
                    <button title="Retirer" disabled=""><i class="fa fa-minus"></i></button>
                  </div>
                  <div class="col">1</div>
                  <div class="col">
                    <button title="Ajouter"><i class="fa fa-plus"></i></button>
                  </div>
                </div>
              </td>
              <td>199,99&thinsp;$</td>
            </tr> */



// const 
// $(function(){
//     if ( document.URL.includes("products.html") ) {
//         var jsonFile="./data/products.json";
//         $.getJSON(jsonFile, function(json){
//             chargement(json);
//         });
//     }
    
// });
// function fichierJson(){
    
// }
// function chargement(json){
    
// }




